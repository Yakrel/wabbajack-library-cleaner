name: Test and Build

on:
  push:
    branches: [ main, pr-3, copilot/add-modlist-cleanup-feature ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Fyne dependencies (Windows)
      shell: pwsh
      run: |
        # Fyne on Windows uses native Windows APIs, no additional dependencies needed
        echo "Windows GUI dependencies are built-in"

    - name: Download dependencies
      run: go mod download

    - name: Run non-GUI tests only
      run: go test -v -run "^(TestParseModFilename|TestDetectOrphanedMods|TestIsValidPath|TestFileExists|TestDeleteFile|TestIsNumeric)$" ./...
      continue-on-error: false

    - name: Run tests with coverage (non-GUI)
      run: go test -v -coverprofile=coverage.txt -covermode=atomic -run "^(TestParseModFilename|TestDetectOrphanedMods|TestIsValidPath|TestFileExists|TestDeleteFile|TestIsNumeric)$" ./...
      continue-on-error: true

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  build:
    name: Build Application
    runs-on: windows-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Fyne dependencies (Windows)
      shell: pwsh
      run: |
        # Fyne on Windows uses native Windows APIs, no additional dependencies needed
        echo "Building GUI application for Windows"

    - name: Download dependencies
      run: go mod download

    - name: Build Windows executable
      run: go build -v -ldflags="-s -w -H=windowsgui" -o wabbajack-library-cleaner.exe
      continue-on-error: false

    - name: Verify build
      shell: pwsh
      run: |
        if (Test-Path wabbajack-library-cleaner.exe) {
          Write-Host "Build successful! File size: $((Get-Item wabbajack-library-cleaner.exe).Length / 1MB) MB"
        } else {
          Write-Error "Build failed - executable not found"
          exit 1
        }

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: wabbajack-library-cleaner-windows
        path: wabbajack-library-cleaner.exe

  lint:
    name: Lint Code
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Download dependencies
      run: go mod download

    - name: Run gofmt check
      shell: pwsh
      run: |
        $unformatted = gofmt -l .
        if ($unformatted) {
          Write-Host "The following files are not formatted:"
          Write-Host $unformatted
          Write-Host "Run 'gofmt -w .' to fix"
          exit 1
        }
        Write-Host "All files are properly formatted"

    - name: Run go vet
      run: go vet ./...
      continue-on-error: false

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m --disable-all --enable=errcheck,gosimple,govet,ineffassign,staticcheck,unused
      continue-on-error: true
