name: Build and Release

on:
  push:
    tags:
      - "v*" # Triggers on tags like v2.1.0
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset_name: wabbajack-library-cleaner-windows.zip
            executable_path: target/release/wabbajack-library-cleaner.exe
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            asset_name: wabbajack-library-cleaner-linux.tar.gz
            executable_path: target/release/wabbajack-library-cleaner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libsoup-3.0-dev libwebkit2gtk-4.1-dev

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Build Release
      run: cargo build --release --verbose

    # --- PACKAGING (WINDOWS) ---
    - name: Package Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $src = "${{ matrix.executable_path }}"
        $dest = "${{ matrix.asset_name }}"
        if (!(Test-Path $src)) { throw "Executable not found at $src" }
        Compress-Archive -Path $src -DestinationPath $dest
        Write-Host "Created $dest"

    # --- PACKAGING (LINUX) ---
    - name: Package Linux
      if: runner.os == 'Linux'
      run: |
        if [ ! -f "${{ matrix.executable_path }}" ]; then echo "Executable not found"; exit 1; fi
        tar -czf ${{ matrix.asset_name }} -C target/release wabbajack-library-cleaner
        echo "Created ${{ matrix.asset_name }}"

    # --- UPLOAD ARTIFACT ---
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: asset-${{ matrix.os }}
        path: ${{ matrix.asset_name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract Changelog
      id: changelog
      run: |
        # Extract the latest version notes from CHANGELOG.md
        # Finds the first version header (## X.X.X) and reads until the next header
        sed -n '/^## /{:a;n;/^## /q;p;ba}' CHANGELOG.md > RELEASE_NOTES.md
        echo "--- Extracted Notes ---"
        cat RELEASE_NOTES.md
        echo "-----------------------"

    - name: Download Windows Asset
      uses: actions/download-artifact@v4
      with:
        name: asset-windows-latest

    - name: Download Linux Asset
      uses: actions/download-artifact@v4
      with:
        name: asset-ubuntu-latest

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        files: |
          wabbajack-library-cleaner-windows.zip
          wabbajack-library-cleaner-linux.tar.gz
        draft: false
        prerelease: false