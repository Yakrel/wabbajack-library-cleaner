name: Test and Build

on:
  push:
    branches: [ main, pr-3 ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\go-build
          ~\go\pkg\mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install Fyne dependencies (Windows)
      shell: pwsh
      run: |
        # Fyne on Windows uses native Windows APIs, no additional dependencies needed
        echo "Windows GUI dependencies are built-in"

    - name: Download dependencies
      run: go mod download

    - name: Run tests with coverage
      run: go test -v -coverprofile=coverage.txt -covermode=atomic ./...
      continue-on-error: false

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  build:
    name: Build Application
    runs-on: windows-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\go-build
          ~\go\pkg\mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install Fyne dependencies (Windows)
      shell: pwsh
      run: |
        # Fyne on Windows uses native Windows APIs, no additional dependencies needed
        echo "Building GUI application for Windows"

    - name: Download dependencies
      run: go mod download

    - name: Build Windows executable
      run: go build -trimpath -v -ldflags="-s -w -H=windowsgui" -o wabbajack-library-cleaner.exe
      continue-on-error: false

    - name: Verify build
      shell: pwsh
      run: |
        if (Test-Path wabbajack-library-cleaner.exe) {
          Write-Host "Build successful! File size: $((Get-Item wabbajack-library-cleaner.exe).Length / 1MB) MB"
        } else {
          Write-Error "Build failed - executable not found"
          exit 1
        }

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: wabbajack-library-cleaner-windows
        path: wabbajack-library-cleaner.exe

  lint:
    name: Lint Code
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\go-build
          ~\go\pkg\mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Check code formatting
      shell: pwsh
      run: |
        $unformatted = gofmt -l .
        if ($unformatted) {
          Write-Error "Code is not formatted. Run 'gofmt -w .' locally"
          Write-Output $unformatted
          exit 1
        }
        Write-Host "Code formatting OK"

    - name: Run go vet
      run: go vet ./...
      continue-on-error: false

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m --disable-all --enable=errcheck,gosimple,govet,ineffassign,staticcheck,unused
      continue-on-error: true
